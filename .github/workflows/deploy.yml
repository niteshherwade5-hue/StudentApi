name: Deploy to IIS

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restore dependencies
        shell: powershell
        run: dotnet restore "WebApplication1.csproj"

      - name: Build
        shell: powershell
        run: dotnet build "WebApplication1.csproj" --configuration Release --no-restore

      - name: Publish
        shell: powershell
        run: dotnet publish "WebApplication1.csproj" -c Release -o publish --no-build

      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "$(Get-Location)\publish"
          $destination = "C:\inetpub\wwwroot\StudentApi"
          $appPool = "StudentApiAppPool"

          Write-Host "Cleaning IIS folder..."
          if (Test-Path $destination) {
              Get-ChildItem -Path $destination -Recurse -Force | Remove-Item -Force -Recurse
          } else {
              New-Item -ItemType Directory -Path $destination | Out-Null
          }

          Write-Host "Copying published files..."
          Copy-Item -Path "$source\*" -Destination $destination -Recurse

          Write-Host "Restarting IIS app pool..."
          Import-Module WebAdministration
          Restart-WebAppPool -Name $appPool

          Write-Host "Deployment complete!"
